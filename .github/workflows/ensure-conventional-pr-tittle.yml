name: Ensure Conventional PR Title
on:
  pull_request_target:
    types: [ready_for_review]
    branches: [develop, main]
permissions:
  pull-requests: write

jobs:
  enforce:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            let title = pr.title || "";
            const labels = (pr.labels || []).map(l => (l.name || "").toLowerCase());

            // already conventional
            if (/^(feat|fix|docs|chore|refactor|perf|style|test|ci)(!?)\s*:/i.test(title)) {
              core.info("Title already conventional");
              return;
            }

            // Map -> prefix + emoji
            const has = (n) => labels.includes(n);
            let prefix = null, emoji = "";
            if (has("feature") || has("feat")) { prefix = "feat"; emoji = " âœ¨"; }
            else if (has("bug"))               { prefix = "fix";  emoji = " ðŸ›"; }
            else if (has("hotfix"))            { prefix = "fix";  emoji = " ðŸš‘"; }
            else if (has("docs") || has("documentation")) { prefix = "docs"; emoji = " ðŸ“"; }
            else if (has("ci"))                { prefix = "ci"; emoji = " ðŸ‘·"; }
            else if (has("refactor"))          { prefix = "refactor"; emoji = " â™»ï¸"; }
            else if (has("chore"))             { prefix = "chore"; emoji = " â™»ï¸"; }
            else if (has("performance") || has("perf")) { prefix = "perf"; emoji = " âš¡ï¸"; }
            else if (has("test"))              { prefix = "test"; emoji = " âœ…"; }

            if (!prefix) {
              core.info("No matching labels -> skipping");
              return;
            }

            // if breaking-change -> feat! / fix!
            const breaking = has("breaking-change") || has("breaking change");
            const bang = breaking ? "!" : "";

            // Add "issue N" if feature/issue-12-...
            const ref = pr.head && pr.head.ref || "";
            const m = false; // ref.match(/issue[-/](\d+)/i);
            const issueStr = m ? ` issue ${m[1]}` : "";

            const newTitle = `${prefix}${bang}:${emoji}${issueStr} ${title}`.replace(/\s+/g, " ").trim();

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              title: newTitle
            });
            core.info(`Updated PR title -> ${newTitle}`);
